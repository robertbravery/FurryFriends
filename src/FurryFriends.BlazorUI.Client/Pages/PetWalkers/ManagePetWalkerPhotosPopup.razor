@namespace FurryFriends.BlazorUI.Client.Pages.PetWalkers
@using FurryFriends.BlazorUI.Client.Models.PetWalkers
@using FurryFriends.BlazorUI.Client.Models.Picture.Enums
@using FurryFriends.BlazorUI.Client.Services.Interfaces
@using FurryFriends.BlazorUI.Client.Services
@using Microsoft.AspNetCore.Components.Forms
@using FurryFriends.BlazorUI.Client.Models
@using FurryFriends.BlazorUI.Client.Models.Picture
@using Microsoft.Extensions.Logging
@inject IPopupService PopupService
@inject IPictureService PictureService
@inject IConfiguration Configuration
@inject ILogger<ManagePetWalkerPhotosPopup> Logger
@rendermode InteractiveServer

@implements IDisposable

@if (_isVisible)
{
    <div class="modal-backdrop">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header modal-header-background">
                    <h5 class="modal-title">Manage Photos for @(_petWalkerPictures?.PetWalkerName ?? "Pet Walker")</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="ClosePopup"></button>
                </div>
                <div class="modal-body">
                    @if (_isLoading)
                    {
                        <p><em>Loading photo information...</em></p>
                    }
                    else if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }
                    else if (_petWalkerPictures != null)
                    {
                        <div class="row">
                            @* Bio Picture Section *@
                            <div class="col-md-4">
                                <div class="bio-picture-section">
                                    <h4>Bio Picture</h4>
                                    <div class="mb-3 text-center">
                                        @{
                                            string bioPicUrl = _petWalkerPictures.ProfilePicture != null && !string.IsNullOrEmpty(_petWalkerPictures.ProfilePicture.Url)
                                                ? GetFullPhotoUrl(_petWalkerPictures.ProfilePicture.Url) // Use helper
                                                : $"https://placehold.co/200x200/e9ecef/495057?text=Bio";
                                        }
                                        <div class="bio-image-container">
                                            <img src="@bioPicUrl" alt="Bio Picture" class="img-thumbnail mb-2" />
                                        </div>
                                        @if (_bioPicturePreviewUrl != null) {
                                            <div class="bio-preview-container">
                                                <img src="@_bioPicturePreviewUrl" alt="New Bio Pic Preview" class="img-thumbnail mb-2" />
                                            </div>
                                        }
                                    </div>
                                    <InputFile OnChange="HandleBioPictureSelected" accept="image/*" class="form-control mb-2" />
                                    <button class="btn btn-primary w-100" @onclick="UploadBioPicture" disabled="@(_selectedBioPictureFile == null || _isUploadingBioPic)">
                                        @(_isUploadingBioPic ? "Uploading..." : "Update Bio Picture")
                                    </button>
                                    @if (!string.IsNullOrEmpty(_bioPicUploadStatus)) { <p class="mt-2">@_bioPicUploadStatus</p> }
                                </div>
                            </div>

                            @* Gallery Photos Section *@
                            <div class="col-md-8">
                                <div class="gallery-section">
                                    <h4>Gallery Photos</h4>
                                    <div class="upload-section mb-4">
                                        <InputFile OnChange="HandleGalleryPhotosSelected" multiple accept="image/*" class="form-control mb-2" />
                                        @* Previews for new gallery photos *@
                                        @if (_galleryPhotoPreviews.Any())
                                        {
                                            <div class="preview-container mb-2">
                                                @foreach(var preview in _galleryPhotoPreviews)
                                                {
                                                    <div class="preview-item">
                                                        <img src="@preview.Url" title="@preview.Name" />
                                                    </div>
                                                }
                                            </div>
                                        }
                                        <button class="btn btn-success w-100" @onclick="UploadGalleryPhotos" disabled="@(!_selectedGalleryFiles.Any() || _isUploadingGallery)">
                                            @(_isUploadingGallery ? "Uploading..." : $"Upload {_selectedGalleryFiles.Count} New Photo(s)")
                                        </button>
                                        @if (!string.IsNullOrEmpty(_galleryUploadStatus)) { <p class="status-message">@_galleryUploadStatus</p> }
                                    </div>

                                    <div class="existing-photos-section">
                                        <h5>Existing Photos</h5>
                                        @if (_petWalkerPictures?.Photos != null && _petWalkerPictures.Photos.Any(p => p.PhotoType != PhotoType.BioPic)) // Filter out bio pic if it's in this list
                                        {
                                            <div class="photos-gallery">
                                                @foreach (var photo in _petWalkerPictures.Photos.Where(p => p.PhotoType != PhotoType.BioPic))
                                                {
                                                    <div class="position-relative">
                                                        <img src="@GetFullPhotoUrl(photo.Url)" alt="@(photo.Description ?? "Gallery Photo")" />
                                                        <button class="btn btn-danger btn-sm" title="Delete Photo"
                                                                @onclick="() => DeleteGalleryPhoto(photo.Id)" disabled="@_isDeleting">
                                                            &times;
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="no-photos-message">No gallery photos uploaded yet.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="ClosePopup">Done</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _isVisible = false;
    private bool _isLoading = false;
    private bool _isUploadingBioPic = false;
    private bool _isUploadingGallery = false;
    private bool _isDeleting = false;
    private string? _errorMessage = null;
    private string? _bioPicUploadStatus = null;
    private string? _galleryUploadStatus = null;
	private PictureViewModel? _petWalkerPictures;
    private string? _photoBaseUrl;

    // Bio Picture State
    private IBrowserFile? _selectedBioPictureFile;
    private string? _bioPicturePreviewUrl;

    // Gallery Photos State
    private List<IBrowserFile> _selectedGalleryFiles = new();
    private List<PhotoPreview> _galleryPhotoPreviews = new();

    private class PhotoPreview {
        public string Url { get; set; } = "";
        public string Name { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        PopupService.OnShowManagePetWalkerPhotosPopup += ShowPopup;
        PopupService.OnCloseManagePetWalkerPhotosPopup += ClosePopupInternal;
        _photoBaseUrl = Configuration["PhotoStorage:BaseUrl"]; // Get base URL
        base.OnInitialized();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogDebug("ManagePetWalkerPhotosPopup first render completed");
            await Task.CompletedTask;
        }
    }

    private async void ShowPopup(Guid petWalkerId)
    {
        Logger.LogInformation("Opening manage photos popup for pet walker ID: {PetWalkerId}", petWalkerId);
        try
        {
            Logger.LogDebug("Setting visibility and loading state");
            _isVisible = true;
            _isLoading = true;
            _errorMessage = null;
            _petWalkerPictures = null; // Reset
            ResetUploadStates();

            await InvokeAsync(StateHasChanged); // Ensure UI updates immediately

            // Fetch specific pet walker details including photos
            Logger.LogDebug("Fetching pet walker photos for ID: {PetWalkerId}", petWalkerId);
            var response = await PictureService.GetPetWalkerPicturesAsync(petWalkerId);

            if (response.Success && response.Data != null)
            {
                _petWalkerPictures = response.Data;
                Logger.LogInformation("Successfully loaded pet walker pictures: Name={Name}, ProfilePic={HasProfilePic}, Photos Count={PhotoCount}",
                    _petWalkerPictures.PetWalkerName,
                    _petWalkerPictures.ProfilePicture != null ? "Present" : "Null",
                    _petWalkerPictures.Photos?.Count.ToString() ?? "null");

                // Ensure Photos collection is initialized
                if (_petWalkerPictures.Photos == null)
                {
                    Logger.LogWarning("Photos collection was null for pet walker {PetWalkerId}, initializing empty list", petWalkerId);
                    _petWalkerPictures.Photos = new List<DetailedPhotoDto>();
                }
            }
            else
            {
                _errorMessage = response.Message ?? "Failed to load pet walker data.";
                Logger.LogWarning("Error loading pet walker data for ID {PetWalkerId}: {ErrorMessage}",
                    petWalkerId, _errorMessage);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
            Logger.LogError(ex, "Exception in ShowPopup for pet walker ID: {PetWalkerId}", petWalkerId);
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged); // Ensure UI updates after loading
        }
    }

    private void ClosePopup()
    {
        PopupService.CloseManagePetWalkerPhotosPopup();
    }

    private void ClosePopupInternal()
    {
        _isVisible = false;
        ResetUploadStates();
        _petWalkerPictures = null; // Clear data
        StateHasChanged();
    }

     private void ResetUploadStates()
    {
        _selectedBioPictureFile = null;
        _bioPicturePreviewUrl = null;
        _selectedGalleryFiles.Clear();
        _galleryPhotoPreviews.Clear();
        _bioPicUploadStatus = null;
        _galleryUploadStatus = null;
        _isUploadingBioPic = false;
        _isUploadingGallery = false;
        _isDeleting = false;
    }

    // --- Bio Picture Handlers ---
    private async Task HandleBioPictureSelected(InputFileChangeEventArgs e)
    {
        _selectedBioPictureFile = e.File;
        _bioPicUploadStatus = null; // Clear previous status
        if (_selectedBioPictureFile != null)
        {
            // Create preview
            var format = "image/jpeg"; // Or derive from file type
            var imageStream = _selectedBioPictureFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB limit example
            using var ms = new MemoryStream();
            await imageStream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            _bioPicturePreviewUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        } else {
            _bioPicturePreviewUrl = null;
        }
        StateHasChanged();
    }

    private async Task UploadBioPicture()
    {
        if (_selectedBioPictureFile == null || _petWalkerPictures == null) return;

        _isUploadingBioPic = true;
        _bioPicUploadStatus = "Uploading...";
        StateHasChanged();

        try
        {
            // Call the service method - this needs to be created
            var response = await PictureService.UpdateBioPictureAsync(_petWalkerPictures.PetWalkerId, _selectedBioPictureFile);
            if (response.Success && response.Data != null)
            {
                // Update the local model with the new bio pic URL/data
                _petWalkerPictures.ProfilePicture = response.Data;
                _bioPicUploadStatus = "Bio picture updated successfully!";
                _selectedBioPictureFile = null; // Clear selection
                _bioPicturePreviewUrl = null; // Clear preview
            }
            else
            {
                _bioPicUploadStatus = $"Error: {response.Message ?? "Upload failed."}";
            }
        }
        catch (Exception ex)
        {
            _bioPicUploadStatus = $"Error: {ex.Message}";
        }
        finally
        {
            _isUploadingBioPic = false;
            StateHasChanged();
        }
    }

    // --- Gallery Photo Handlers ---
    private async Task HandleGalleryPhotosSelected(InputFileChangeEventArgs e)
    {
        _selectedGalleryFiles.Clear();
        _galleryPhotoPreviews.Clear();
        _galleryUploadStatus = null;

        foreach (var file in e.GetMultipleFiles(maximumFileCount: 10)) // Limit concurrent uploads
        {
             try {
                _selectedGalleryFiles.Add(file);
                // Create previews
                var format = "image/jpeg";
                var imageStream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB limit
                using var ms = new MemoryStream();
                await imageStream.CopyToAsync(ms);
                var buffer = ms.ToArray();
                _galleryPhotoPreviews.Add(new PhotoPreview { Url = $"data:{format};base64,{Convert.ToBase64String(buffer)}", Name = file.Name });
             } catch (IOException ex) {
                 _galleryUploadStatus = $"Error reading {file.Name}: {ex.Message}"; // Handle file size errors etc.
             }
        }
        StateHasChanged();
    }

    private async Task UploadGalleryPhotos()
    {
        if (!_selectedGalleryFiles.Any() || _petWalkerPictures == null) return;

        _isUploadingGallery = true;
        _galleryUploadStatus = $"Uploading {_selectedGalleryFiles.Count} photos...";
        StateHasChanged();

        try
        {
            // Call the service method - needs to be created
            var response = await PictureService.AddPhotosAsync(_petWalkerPictures.PetWalkerId, _selectedGalleryFiles);
            if (response.Success && response.Data != null)
            {
                 // Add new photos to the local list
                if (_petWalkerPictures.Photos == null) _petWalkerPictures.Photos = new List<DetailedPhotoDto >();
                _petWalkerPictures.Photos.AddRange(response.Data); // Assuming response returns the newly added photos
                _galleryUploadStatus = $"{response.Data.Count} photo(s) uploaded successfully!";
                _selectedGalleryFiles.Clear(); // Clear selection
                _galleryPhotoPreviews.Clear(); // Clear previews
            }
            else
            {
                _galleryUploadStatus = $"Error: {response.Message ?? "Upload failed."}";
            }
        }
        catch (Exception ex)
        {
            _galleryUploadStatus = $"Error: {ex.Message}";
        }
        finally
        {
            _isUploadingGallery = false;
            StateHasChanged();
        }
    }

     private async Task DeleteGalleryPhoto(Guid photoId)
    {
        if (_petWalkerPictures == null) return;

        // Optional: Add a confirmation dialog here

        _isDeleting = true;
        _galleryUploadStatus = "Deleting photo..."; // Use gallery status for feedback
        StateHasChanged();

        try
        {
            // Call the service method - needs to be created
            var response = await PictureService.DeletePhotoAsync(_petWalkerPictures.PetWalkerId, photoId);
            if (response.Success)
            {
                // Remove photo from local list
                _petWalkerPictures.Photos?.RemoveAll(p => p.Id == photoId);
                _galleryUploadStatus = "Photo deleted successfully!";
            }
            else
            {
                _galleryUploadStatus = $"Error: {response.Message ?? "Deletion failed."}";
            }
        }
        catch (Exception ex)
        {
            _galleryUploadStatus = $"Error: {ex.Message}";
        }
        finally
        {
            _isDeleting = false;
            StateHasChanged();
        }
    }

    // Helper to construct full URL
    private string GetFullPhotoUrl(string relativePath)
    {
        if (string.IsNullOrEmpty(relativePath)) return ""; // Or return placeholder
        if (Uri.TryCreate(relativePath, UriKind.Absolute, out _)) return relativePath; // Already absolute
        if (string.IsNullOrEmpty(_photoBaseUrl)) return relativePath; // No base URL configured

        // Ensure no double slashes
        var baseUrl = _photoBaseUrl.TrimEnd('/');
        var relPath = relativePath.TrimStart('/');
        return $"{baseUrl}/{relPath}";
    }


    public void Dispose()
    {
        PopupService.OnShowManagePetWalkerPhotosPopup -= ShowPopup;
        PopupService.OnCloseManagePetWalkerPhotosPopup -= ClosePopupInternal;
    }
}
